# Sonarr CI/CD with micro-chef
# Build, generate SBOM, sign, and push to Quay.io
name: Sonarr CI/CD

on: [workflow_dispatch]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: deploy
    permissions:
      contents: read
      id-token: write  # Required for keyless signing with Sigstore

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah

      - name: Install security tools
        run: |
          # Install syft for SBOM generation
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          # Install cosign for image signing
          curl -sSfL https://raw.githubusercontent.com/sigstore/cosign/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Install micro-chef from private repo
        run: pip install git+https://${{ secrets.MICRO_CHEF_PAT }}@github.com/CastawayEGR/micro-chef.git

      - name: Get latest Sonarr version
        run: |
          echo "LATEST_SONARR_VERSION=$(curl -sL 'https://services.sonarr.tv/v1/update/master/changes?runtime=netcore&os=linux&version=4' | jq -r '.[0].version')" >> "$GITHUB_ENV"

      - name: Build image with micro-chef
        run: |
          SONARR_VERSION=${{ env.LATEST_SONARR_VERSION }} micro-chef build recipe.yaml

      - name: Tag image with versions
        run: |
          buildah tag sonarr sonarr:latest
          buildah tag sonarr sonarr:${{ env.LATEST_SONARR_VERSION }}
          buildah tag sonarr sonarr:${{ github.sha }}

      - name: Generate SBOM
        run: |
          mkdir -p sbom
          micro-chef sbom sonarr:latest --format spdx-json --output sbom/sbom-spdx.json
          micro-chef sbom sonarr:latest --format cyclonedx-json --output sbom/sbom-cyclonedx.json

      - name: Login to Quay.io
        run: buildah login -u ${{ secrets.QUAY_USERNAME }} -p ${{ secrets.QUAY_PASSWORD }} quay.io

      - name: Push images to Quay.io
        run: |
          buildah push sonarr:latest docker://quay.io/castawayegr/sonarr:latest
          buildah push sonarr:${{ env.LATEST_SONARR_VERSION }} docker://quay.io/castawayegr/sonarr:${{ env.LATEST_SONARR_VERSION }}
          buildah push sonarr:${{ github.sha }} docker://quay.io/castawayegr/sonarr:${{ github.sha }}

      - name: Sign images with Sigstore (keyless)
        run: |
          micro-chef sign quay.io/castawayegr/sonarr:latest --keyless
          micro-chef sign quay.io/castawayegr/sonarr:${{ env.LATEST_SONARR_VERSION }} --keyless
          micro-chef sign quay.io/castawayegr/sonarr:${{ github.sha }} --keyless

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sonarr-sbom-${{ env.LATEST_SONARR_VERSION }}
          path: sbom/
          retention-days: 90
